name: Deploy APy to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'apy-server/**'
      # Trigger when dictionary changes are merged
      - '.github/workflows/deploy-ec2.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even without changes'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔐 Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: 📝 Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: 🚀 Deploy to EC2
      env:
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        ssh $EC2_USER@$EC2_HOST << 'ENDSSH'
          set -e
          
          cd /opt/ido-epo-translator
          
          echo "📥 Pulling latest dictionary changes..."
          cd apertium-ido-epo && git pull origin main && cd ..
          
          echo "🐳 Rebuilding Docker container..."
          docker-compose build --no-cache
          
          echo "🔄 Restarting service..."
          docker-compose down
          docker-compose up -d
          
          echo "⏳ Waiting for service to be healthy..."
          sleep 10
          
          # Check if service is up
          if curl -f http://localhost:2737/listPairs; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed - service not responding"
            exit 1
          fi
        ENDSSH
    
    - name: 📊 Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ APy server deployed successfully to EC2"
        else
          echo "❌ Deployment failed"
        fi

